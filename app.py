import streamlit as st
import openai

# 1. í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
st.set_page_config(page_title="ë‚˜ë§Œì˜ ì§€ì—­ ì´ì•¼ê¸° ë§Œë“¤ê¸°", page_icon="ğŸ—ºï¸")

st.title("ğŸ—ºï¸ 243ê°œ ì§€ì—­: ë‚˜ë§Œì˜ ì´ì•¼ê¸° ìƒì„±ê¸°")
st.write("ì›í•˜ëŠ” ì§€ì—­ì„ ì„ íƒí•˜ê³ , ë‹¹ì‹ ë§Œì˜ ìƒìƒë ¥ì„ ë”í•´ ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!")

# 2. ê°€ìƒì˜ ë°ì´í„° (ë‚˜ì¤‘ì—ëŠ” 243ê°œ ë°ì´í„°ë² ì´ìŠ¤ë‚˜ ì—‘ì…€ íŒŒì¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤)
# ì˜ˆì‹œë¡œ 3ê°œë§Œ ë„£ì–´ë‘ì—ˆìŠµë‹ˆë‹¤.
region_data = {
    "ì„œìš¸ ì¢…ë¡œ": {
        "story": "ê³¼ê±°ì™€ í˜„ì¬ê°€ ê³µì¡´í•˜ëŠ” ê±°ë¦¬, ì˜¤ë˜ëœ ê³¨ëª©ë§ˆë‹¤ ì‹œê°„ ì—¬í–‰ìê°€ ìˆ¨ì–´ ìˆë‹¤.",
        "character": "ê¹€ì‹œê°„ (íšŒì¤‘ì‹œê³„ë¥¼ ë“  ê³¨ë™í’ˆ ê°€ê²Œ ì£¼ì¸)"
    },
    "ë¶€ì‚° í•´ìš´ëŒ€": {
        "story": "í‘¸ë¥¸ ë°”ë‹¤ ì•„ë˜ ìš©ê¶ìœ¼ë¡œ ê°€ëŠ” ë¹„ë°€ í†µë¡œê°€ ì¡´ì¬í•œë‹¤.",
        "character": "ë°•íŒŒë„ (ë§í•˜ëŠ” ê°ˆë§¤ê¸°ì™€ ëŒ€í™”í•˜ëŠ” ì„œí¼)"
    },
    "ì „ì£¼ í•œì˜¥ë§ˆì„": {
        "story": "í•œë³µì„ ì…ìœ¼ë©´ ì¡°ì„ ì‹œëŒ€ì˜ ê¸°ì–µì„ ì—¿ë³¼ ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì´ ìƒê¸´ë‹¤.",
        "character": "ì´ë‹¨ì•„ (ë¹„ë°€ì„ ê°„ì§í•œ í•œë³µ ë””ìì´ë„ˆ)"
    }
}

# Secretsì—ì„œ í‚¤ë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜, ì—†ìœ¼ë©´ ì…ë ¥ë°›ê¸°
if "OPENAI_API_KEY" in st.secrets:
    api_key = st.secrets["OPENAI_API_KEY"]
else:
    api_key = st.sidebar.text_input("API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
# 3. ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ (UI) êµ¬ì„±
# ì§€ì—­ ì„ íƒ
selected_region = st.selectbox("ì–´ë–¤ ì§€ì—­ì˜ ì´ì•¼ê¸°ë¥¼ ì›í•˜ì‹œë‚˜ìš”?", list(region_data.keys()))

if selected_region:
    # ì„ íƒëœ ì§€ì—­ ì •ë³´ ë³´ì—¬ì£¼ê¸°
    info = region_data[selected_region]
    st.info(f"**ê¸°ë³¸ ì„¤ì •**\n\n* **ìŠ¤í† ë¦¬:** {info['story']}\n* **ìºë¦­í„°:** {info['character']}")

    # ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
    user_idea = st.text_area("ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ë¥¼ ë”í•´ì£¼ì„¸ìš”! (ì˜ˆ: ì£¼ì¸ê³µì´ ê°‘ìê¸° ì´ˆëŠ¥ë ¥ì„ ì–»ê²Œ ëœë‹¤ë©´?)")

    # ì´ì•¼ê¸° ìƒì„± ë²„íŠ¼
    if st.button("ìƒˆë¡œìš´ ì´ì•¼ê¸° ë§Œë“¤ê¸° âœ¨"):
        if not api_key:
            st.warning("ë¨¼ì € ì™¼ìª½ ì‚¬ì´ë“œë°”ì— OpenAI API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            # API í‚¤ê°€ ì—†ì„ ë•Œ í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ ì‘ë‹µ
            st.markdown("---")
            st.subheader("ğŸ¤– AIê°€ ë§Œë“  ì´ì•¼ê¸° (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)")
            st.write(f"í…ŒìŠ¤íŠ¸ ëª¨ë“œì…ë‹ˆë‹¤.\n\n'{selected_region}'ì˜ '{info['character']}'ê°€ '{user_idea}'ë¼ëŠ” ìƒí™©ì„ ê²ªëŠ” ë©‹ì§„ ì´ì•¼ê¸°ê°€ ìƒì„±ë  ì˜ˆì •ì…ë‹ˆë‹¤!")
        else:
            # ì‹¤ì œ AI í˜¸ì¶œ ë¡œì§
            try:
                client = openai.OpenAI(api_key=api_key)
                
                prompt = f"""
                ë‹¹ì‹ ì€ ì°½ì˜ì ì¸ ì†Œì„¤ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ì„¤ì •ì„ ë°”íƒ•ìœ¼ë¡œ ìƒˆë¡œìš´ ì§§ì€ ì†Œì„¤ì„ ì¨ì£¼ì„¸ìš”.
                
                [ê¸°ë³¸ ì„¤ì •]
                - ì§€ì—­: {selected_region}
                - ë°°ê²½ ìŠ¤í† ë¦¬: {info['story']}
                - ì£¼ì¸ê³µ: {info['character']}
                
                [ì‚¬ìš©ì ì•„ì´ë””ì–´]
                {user_idea}
                
                ìœ„ ë‚´ìš©ì„ ê²°í•©í•˜ì—¬ í¥ë¯¸ì§„ì§„í•œ ì´ì•¼ê¸°ë¥¼ 500ì ë‚´ì™¸ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.
                """
                
                with st.spinner("AIê°€ ì—´ì‹¬íˆ ì´ì•¼ê¸°ë¥¼ ì“°ê³  ìˆìŠµë‹ˆë‹¤..."):
                    response = client.chat.completions.create(
                        model="gpt-3.5-turbo", # ë˜ëŠ” gpt-4
                        messages=[{"role": "user", "content": prompt}]
                    )
                    story_result = response.choices[0].message.content
                
                st.markdown("---")
                st.subheader(f"ğŸ“– {selected_region}ì˜ ìƒˆë¡œìš´ ì „ì„¤")
                st.write(story_result)
                
            except Exception as e:
                st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
